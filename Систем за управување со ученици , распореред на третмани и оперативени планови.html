<!DOCTYPE html>
<html lang="mk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Електронски дневник</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
        }
        .header h1 { font-size: 1.3em; margin-bottom: 5px; }
        .header p { font-size: 0.85em; opacity: 0.95; }
        .tabs {
            display: flex;
            justify-content: center;
            background: linear-gradient(to bottom, #1a1a2e 0%, #16213e 100%);
            border-bottom: 3px solid #0f3460;
            padding: 0 10px;
            gap: 5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .tab {
            padding: 12px 30px;
            border: none;
            background: linear-gradient(to bottom, #2d3748 0%, #1a202c 100%);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 15px;
            color: #a0aec0;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            clip-path: polygon(10px 0, 100% 0, calc(100% - 10px) 100%, 0 100%);
            margin-top: 5px;
            border-top: 2px solid #4a5568;
        }
        .tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #667eea, transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tab:hover {
            background: linear-gradient(to bottom, #4a5568 0%, #2d3748 100%);
            color: #e2e8f0;
        }
        .tab:hover::before {
            opacity: 1;
        }
        .tab.active {
            background: linear-gradient(to bottom, #667eea 0%, #5568d3 100%);
            color: #ffffff;
            font-weight: bold;
            margin-top: 0;
            padding-top: 17px;
            border-top: 3px solid #818cf8;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
        }
        .tab.active::before {
            opacity: 1;
            background: linear-gradient(90deg, transparent, #ffffff, transparent);
        }
        .content { 
            padding: 20px;
            background: white;
            min-height: calc(100vh - 150px);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s;
        }
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #48bb78; color: white; }
        .btn-full {
            width: 100%;
            padding: 15px;
            font-size: 15px;
        }
        .section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }
        .stats-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-box h2 { font-size: 2.5em; margin-bottom: 5px; }
        .stat-box p { font-size: 0.9em; opacity: 0.95; }
        
        .capacity-box {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .capacity-box h3 {
            margin-bottom: 15px;
            color: #2d3748;
            font-size: 1.1em;
        }
        .capacity-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            font-size: 14px;
        }
        .capacity-item .icon {
            font-size: 18px;
        }
        .progress-bar-container {
            width: 100%;
            height: 30px;
            background: #e2e8f0;
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
            position: relative;
        }
        .progress-bar-fill {
            height: 100%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 13px;
        }
        .progress-bar-fill.green { background: linear-gradient(90deg, #48bb78 0%, #38a169 100%); }
        .progress-bar-fill.yellow { background: linear-gradient(90deg, #ecc94b 0%, #d69e2e 100%); }
        .progress-bar-fill.red { background: linear-gradient(90deg, #f56565 0%, #e53e3e 100%); }
        
        body.dark-mode .capacity-box { background: #2d3748; border-color: #4a5568; }
        body.dark-mode .capacity-box h3 { color: #e2e8f0; }
        body.dark-mode .capacity-item { color: #e2e8f0; }
        body.dark-mode #sessionSummary { border-top-color: #4a5568; }
        body.dark-mode #sessionSummary strong { color: #e2e8f0; }
        body.dark-mode #sessionSummary .capacity-item span { color: #e2e8f0 !important; }
        .student-list-simple {
            background: white;
        }
        .student-item {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .student-item:hover {
            background: #f7fafc;
        }
        .student-item-info {
            flex: 1;
        }
        .student-item h4 {
            font-size: 15px;
            margin-bottom: 3px;
        }
        .student-item p {
            font-size: 13px;
            color: #718096;
        }
        .student-item-actions {
            display: flex;
            gap: 5px;
        }
        .form-group { margin-bottom: 20px; }
        .form-group label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600;
            font-size: 14px;
        }
        .form-group select, .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
        }
        .progress-list {
            margin-top: 20px;
        }
        .progress-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            margin: 8px 0;
            background: #f7fafc;
            border-radius: 6px;
            border-left: 3px solid #cbd5e0;
        }
        .progress-item.completed {
            background: #e6fffa;
            border-left-color: #48bb78;
        }
        .progress-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-top: 2px;
        }
        .progress-item-content {
            flex: 1;
        }
        .progress-item-text {
            font-size: 14px;
            margin-bottom: 3px;
        }
        .progress-item-date {
            font-size: 12px;
            color: #718096;
        }
        .time-selector {
            margin-top: 8px;
        }
        .time-selector select {
            padding: 8px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 13px;
        }
        .attendance-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 13px;
        }
        .attendance-table th {
            background: #667eea;
            color: white;
            padding: 10px;
            text-align: left;
            font-weight: 600;
        }
        .attendance-table td {
            padding: 10px;
            border: 1px solid #f1f5f9;
        }
        .attendance-table tr:nth-child(even) {
            background: #f8fafc;
        }
        .date-cell {
            background: #e6fffa;
            text-align: center;
            font-size: 12px;
        }
        .schedule-grid {
            display: grid;
            grid-template-columns: 80px repeat(5, 1fr);
            gap: 1px;
            background: #f1f5f9; /* Grid line color */
            border-radius: 8px;
            overflow: hidden;
            margin-top: 15px;
            border: 1px solid #f1f5f9;
            min-width: 100%;
            width: max-content;
        }
        .schedule-header {
            background: #667eea;
            color: white;
            padding: 12px 5px;
            font-weight: 600;
            text-align: center;
            font-size: 12px;
        }
        .schedule-time {
            background: #000;
            color: white;
            padding: 10px 5px;
            text-align: center;
            font-size: 17px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .schedule-cell {
            background: white;
            padding: 8px 4px;
            min-height: 80px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .schedule-cell.odd-row {
            background: #f8fafc;
        }
        .schedule-cell:hover { background: #edf2f7; }
        .student-slot {
            background: #e6fffa;
            padding: 6px;
            border-radius: 4px;
            margin: 3px 0;
            font-size: 17px;
            font-weight: bold;
            border-left: 3px solid #38b2ac;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            text-align: center;
            min-height: 30px;
            position: relative;
        }
        .student-slot-name {
            flex: 1;
            text-align: center;
        }
        .student-slot-order {
            position: absolute;
            left: 8px;
            font-size: 11px;
            background: rgba(0,0,0,0.1);
            padding: 2px 5px;
            border-radius: 3px;
        }
        .student-slot.linked-first {
            border-bottom: 2px dashed #38b2ac;
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            margin-bottom: 0;
        }
        .student-slot.linked-second {
            border-top: none;
            border-top-left-radius: 0;
            border-top-right-radius: 0;
            margin-top: 0;
        }
        .student-slot.linked-first::after {
            content: ' ↓';
            margin-left: 5px;
            font-size: 14px;
        }
        .student-slot.linked-second::before {
            content: '↑ ';
            margin-right: 5px;
            font-size: 14px;
        }
        .student-slot.present { 
            background: rgba(72, 187, 120, 0.3); 
            border-left-color: #48bb78;
        }
        .student-slot.absent { 
            background: rgba(245, 101, 101, 0.3);
            border-left-color: #f56565;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .checkbox-list {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px;
        }
        .checkbox-item {
            padding: 10px;
            margin: 5px 0;
            background: #f7fafc;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .week-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
         /* Dark Mode Toggle */
        .theme-switch-wrapper {
            display: flex;
            align-items: center;
            position: absolute;
            top: 20px;
            right: 20px;
        }
        .theme-switch {
            display: inline-block;
            height: 24px;
            position: relative;
            width: 50px;
        }
        .theme-switch input { display:none; }
        .slider {
            background-color: #ccc;
            bottom: 0;
            cursor: pointer;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            background-color: #fff;
            bottom: 4px;
            content: "";
            height: 16px;
            left: 4px;
            position: absolute;
            transition: .4s;
            width: 16px;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #667eea;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* Dark Mode Styles */
        body.dark-mode {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            color: #e2e8f0;
        }
        body.dark-mode .header,
        body.dark-mode .stat-box,
        body.dark-mode .section-header {
            background: linear-gradient(135deg, #4c51bf 0%, #2d3748 100%);
        }
        body.dark-mode .tabs { background: #2d3748; border-bottom-color: #4a5568; }
        body.dark-mode .tab { 
            background: linear-gradient(to bottom, #1a202c 0%, #0f1419 100%); 
            color: #718096;
            border-top-color: #2d3748;
        }
        body.dark-mode .tab:hover {
            background: linear-gradient(to bottom, #2d3748 0%, #1a202c 100%);
            color: #cbd5e0;
        }
        body.dark-mode .tab.active { 
            background: linear-gradient(to bottom, #818cf8 0%, #6366f1 100%);
            color: #ffffff;
            border-top-color: #a5b4fc;
        }
        body.dark-mode .content, body.dark-mode .student-list-simple { background: #1a202c; }
        body.dark-mode .student-item { border-bottom-color: #4a5568; }
        body.dark-mode .student-item:hover { background: #2d3748; }
        body.dark-mode .student-item h4 { color: #e2e8f0; }
        body.dark-mode .student-list-simple h3 { color: #e2e8f0; border-bottom-color: #818cf8; }
        body.dark-mode .student-item p { color: #a0aec0; }
        body.dark-mode .form-group select, body.dark-mode .form-group input, body.dark-mode .form-group textarea { background: #2d3748; border-color: #4a5568; color: #e2e8f0; }
        body.dark-mode .progress-item { background: #2d3748; border-left-color: #718096; }
        body.dark-mode .progress-item.completed { background: #2c5282; border-left-color: #63b3ed; }
        body.dark-mode .attendance-table th { background: #4c51bf; }
        body.dark-mode .attendance-table td { border-color: #334155; }
        body.dark-mode .attendance-table tr:nth-child(even) { background: #1e293b; }
        body.dark-mode .date-cell { background: #2c5282; }
        body.dark-mode .schedule-grid { background: #334155; border-color: #334155; } /* Grid line color */
        body.dark-mode .schedule-header { background: #4c51bf; }
        body.dark-mode .schedule-cell { background: #0f172a; }
        body.dark-mode .schedule-cell.odd-row { background: #1e293b; }
        body.dark-mode .schedule-cell:hover { background: #4a5568; }
        body.dark-mode .student-slot { background: #2c5282; border-left-color: #63b3ed; color: #e2e8f0; }
        body.dark-mode .student-slot.linked-first { border-bottom-color: #63b3ed; }
        body.dark-mode .student-slot.present { background: rgba(72, 187, 120, 0.4); border-left-color: #48bb78; }
        body.dark-mode .student-slot.absent { background: rgba(245, 101, 101, 0.4); border-left-color: #f56565; }
        body.dark-mode .student-slot-order { background: rgba(255,255,255,0.15); }
        body.dark-mode .modal-content { background: #2d3748; }
        body.dark-mode .checkbox-list { border-color: #4a5568; }
        body.dark-mode .checkbox-item { background: #1a202c; }
        body.dark-mode .week-nav { background: #2d3748; }
        body.dark-mode div[style*="background: #f7fafc"] { background: #2d3748 !important; }

        .scrollable-container {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        @media (max-width: 768px) {
            .header h1 { font-size: 1.1em; }
            .header h2 { font-size: 0.8em; }
            .header h4 { font-size: 0.7em; }

            .tabs {
                flex-direction: column;
            }
            .tab {
                border-bottom: 1px solid #dee2e6;
            }
            .tab.active {
                border-bottom: 3px solid #667eea;
            }
            body.dark-mode .tab {
                border-bottom-color: #4a5568;
            }
            body.dark-mode .tab.active {
                border-bottom-color: #818cf8;
            }

            .stats-row {
                grid-template-columns: 1fr;
            }

            div[style*="grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr !important;
            }

            .scrollable-container {
                overflow-x: auto;
            }

            .schedule-grid {
                min-width: 630px;
            }
            
            .attendance-table {
                min-width: 800px;
            }

            .modal-content {
                width: 95%;
                padding: 15px;
            }
        }
   </style>
</head>
<body>
    <div class="header">
        <div class="theme-switch-wrapper">
            <label class="theme-switch" for="checkbox">
                <input type="checkbox" id="checkbox" />
                <div class="slider round"></div>
            </label>
        </div>
        <div style="text-align: center;">
            <h1 style="font-size: 2.8em; margin: 10px 0; text-shadow: 0 4px 8px rgba(0,0,0,0.3); letter-spacing: 2px; font-weight: 700;">
                📚 ЕЛЕКТРОНСКИ ДНЕВНИК
            </h1>
            <h2 style="font-size: 1.1em; margin: 8px 0; opacity: 0.95;">Кабинет за слух, говор, глас, алтернатива и аугментативна комуникација</h2>
            <h4 style="font-size: 0.85em; margin: 8px 0; opacity: 0.85;">Систем за управување ученици со неделен распоред на третмани и напредокот во оперативниот план</h4>
        </div>
    </div>
    
    <div class="tabs">
        <button class="tab" onclick="switchTab('students')">Ученици</button>
        <button class="tab active" onclick="switchTab('schedule')">Распоред</button>
        <button class="tab" onclick="switchTab('progress')">Напредок</button>
        <button class="tab" onclick="switchTab('plans')">Планови</button>
        <button class="tab" onclick="switchTab('data')">Податоци</button>
    </div>
    
    <div class="content">
        <!-- Students Tab -->
        <div id="students" class="tab-content">
            <button class="btn btn-primary btn-full" onclick="showAddStudentModal()">+ Додади Ученик</button>
            
            <div id="studentListSimple" class="student-list-simple"></div>
            
            <div class="capacity-box">
                <h3>📋 Искористеност на распоредот</h3>
                <div class="capacity-item">
                    <span class="icon">👤</span>
                    <span id="capacityUsage">0/1000 мин | 0% искористено</span>
                </div>
                <div class="progress-bar-container">
                    <div id="capacityProgressBar" class="progress-bar-fill green" style="width: 0%;">0%</div>
                </div>
                <div id="capacityAlert"></div>
                <div id="sessionSummary" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e2e8f0;"></div>
            </div>
        </div>
        
        <!-- Schedule Tab -->
        <div id="schedule" class="tab-content active">
            <div class="week-nav">
                <button class="btn btn-primary" onclick="changeWeek(-1)">← Претходна</button>
                <h3 id="weekDisplay"></h3>
                <button class="btn btn-primary" onclick="changeWeek(1)">Следна →</button>
            </div>
            <button class="btn btn-success" onclick="manualSave()">Зачувај</button>
            <button class="btn btn-primary" onclick="showMonthlyAttendance()">Избриши</button>
            <div class="scrollable-container">
                <div id="scheduleGrid"></div>
            </div>
        </div>
        
        <!-- Progress Tab -->
        <div id="progress" class="tab-content">
            <div class="section-header">Следење на Напредок</div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <button class="btn btn-primary btn-full" onclick="switchProgressView('student')">Реализација на оперативен план</button>
                <button class="btn btn-success btn-full" onclick="switchProgressView('monthly')">Присутност по месец</button>
            </div>
            
            <div id="studentProgressView">
                <div class="form-group">
                    <label>Избери Ученик:</label>
                    <select id="progressStudentSelect" onchange="loadStudentProgress()">
                        <option value="">-- Избери ученик --</option>
                    </select>
                </div>
                <div id="progressActivitiesList" class="progress-list"></div>
            </div>
            
            <div id="monthlyProgressView" style="display: none;">
                <div class="form-group">
                    <label>Избери месец:</label>
                    <input type="month" id="monthSelector" onchange="generateMonthlyAttendance()">
                </div>
                <div class="scrollable-container">
                    <div id="monthlyAttendanceTable"></div>
                </div>
            </div>
        </div>
        
        <!-- Plans Tab -->
        <div id="plans" class="tab-content">
            <button class="btn btn-primary btn-full" onclick="showAddPlanModal()">+ Креирај План</button>
            <div id="plansList" style="margin-top: 20px;"></div>
        </div>
        
        <!-- Data Tab -->
        <div id="data" class="tab-content">
            <div class="section-header">Експорт / Импорт</div>
            <button class="btn btn-success btn-full" onclick="exportData()">Експортирај Сè (JSON)</button>
            <button class="btn btn-primary btn-full" onclick="document.getElementById('importFile').click()">Импортирај JSON</button>
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
        </div>
    </div>
    
    <!-- Add Student Modal -->
    <div id="addStudentModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 15px;">Додади Ученик</h2>
            <div class="form-group">
                <label>Име и Презиме</label>
                <input type="text" id="studentName" placeholder="пр. Марија Чадамова">
            </div>
            <div class="form-group">
                <label>Одделение</label>
                <input type="text" id="studentGrade" placeholder="пр. IV-а">
            </div>
            <div class="form-group">
                <label>План</label>
                <select id="studentPlan"></select>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-success" style="flex: 1;" onclick="saveStudent()">Зачувај</button>
                <button class="btn" style="flex: 1; background: #718096; color: white;" onclick="closeModal('addStudentModal')">Откажи</button>
            </div>
        </div>
    </div>
    
    <!-- Add Plan Modal -->
    <div id="addPlanModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 15px;">Креирај План</h2>
            <div class="form-group">
                <label>Име на План</label>
                <input type="text" id="planName" placeholder="пр. План 1">
            </div>
            <div class="form-group">
                <label>Активности (една по ред)</label>
                <textarea id="planActivities" rows="10" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px;"></textarea>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-success" style="flex: 1;" onclick="savePlan()">Зачувај</button>
                <button class="btn" style="flex: 1; background: #718096; color: white;" onclick="closeModal('addPlanModal')">Откажи</button>
            </div>
        </div>
    </div>
    
    <!-- Assign Modal -->
    <div id="assignModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 15px;">Доделете Ученици</h2>
            <div id="checkboxList" class="checkbox-list"></div>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn btn-success" style="flex: 1;" onclick="assignStudents()">Зачувај</button>
                <button class="btn" style="flex: 1; background: #718096; color: white;" onclick="closeModal('assignModal')">Откажи</button>
            </div>
        </div>
    </div>
    
    <script>
        var students = [];
        var schedule = {
            monday: [[], [], [], [], []],
            tuesday: [[], [], [], [], []],
            wednesday: [[], [], [], [], []],
            thursday: [[], [], [], [], []],
            friday: [[], [], [], [], []]
        };
        var attendance = {};
        var plans = [];
        var studentProgress = {};
        
        var currentWeek = 0;
        var editingStudent = null;
        var editingPlan = null;
        var currentSlot = null;
        var isDataDirty = false;
        var checkOrder = [];
        
        var days = ['Пон', 'Вто', 'Сре', 'Чет', 'Пет'];
        var daysEng = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
        var timeSlots = [
            { label: 'I', time: '08:00-08:40' },
            { label: 'II', time: '08:45-09:25' },
            { label: 'III', time: '09:40-10:20' },
            { label: 'IV', time: '10:25-11:05' },
            { label: 'V', time: '11:10-11:50' }
        ];
        
        function switchTab(tab) {
            var tabs = document.querySelectorAll('.tab');
            var contents = document.querySelectorAll('.tab-content');
            
            for (var i = 0; i < tabs.length; i++) tabs[i].classList.remove('active');
            for (var i = 0; i < contents.length; i++) contents[i].classList.remove('active');
            
            event.target.classList.add('active');
            document.getElementById(tab).classList.add('active');
            
            if (tab === 'students') updateStats();
            if (tab === 'schedule') renderSchedule();
            if (tab === 'progress') updateProgressStudentList();
        }
        
        function showAddStudentModal() {
            updatePlanDropdown();
            document.getElementById('studentName').value = '';
            document.getElementById('studentGrade').value = '';
            document.getElementById('addStudentModal').classList.add('active');
        }
        
        function showAddPlanModal() {
            editingPlan = null;
            document.getElementById('planName').value = '';
            document.getElementById('planActivities').value = '';
            document.getElementById('addPlanModal').querySelector('h2').textContent = 'Креирај План';
            document.getElementById('addPlanModal').classList.add('active');
        }
        
        function editPlan(idx) {
            editingPlan = idx;
            var plan = plans[idx];
            document.getElementById('planName').value = plan.name;
            document.getElementById('planActivities').value = plan.activities.join('\n');
            document.getElementById('addPlanModal').querySelector('h2').textContent = 'Измени План';
            document.getElementById('addPlanModal').classList.add('active');
        }
        
        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }
        
        function updatePlanDropdown() {
            var select = document.getElementById('studentPlan');
            select.innerHTML = '';
            
            if (plans.length === 0) {
                var opt = document.createElement('option');
                opt.value = '';
                opt.textContent = 'Нема планови - креирајте план прво';
                select.appendChild(opt);
            } else {
                for (var i = 0; i < plans.length; i++) {
                    var opt = document.createElement('option');
                    opt.value = plans[i].id;
                    opt.textContent = plans[i].name;
                    select.appendChild(opt);
                }
            }
        }
        
        function saveStudent() {
            var name = document.getElementById('studentName').value.trim();
            var grade = document.getElementById('studentGrade').value.trim();
            var planId = parseInt(document.getElementById('studentPlan').value);

            if (!name || !grade || !planId) {
                alert('Пополнете ги сите полиња');
                return;
            }

            if (editingStudent !== null) {
                // Editing existing student
                students[editingStudent].name = name;
                students[editingStudent].grade = grade;
                students[editingStudent].planId = planId;
                editingStudent = null;
            } else {
                // Adding new student
                var newStudent = { id: Date.now(), name: name, grade: grade, planId: planId };
                students.push(newStudent);
                studentProgress[newStudent.id] = {};
                studentProgress[newStudent.id][planId] = [];
            }
            
            saveData();
            renderStudentListSimple();
            updateStats();
            updateProgressStudentList();
            closeModal('addStudentModal');
        }
        
        function savePlan() {
            var name = document.getElementById('planName').value.trim();
            var activitiesText = document.getElementById('planActivities').value.trim();
            
            if (!name || !activitiesText) {
                alert('Пополнете ги сите полиња');
                return;
            }
            
            var activities = activitiesText.split('\n').map(function(a) { return a.trim(); }).filter(function(a) { return a.length > 0; });
            
            if (editingPlan !== null) {
                // Editing existing plan
                plans[editingPlan].name = name;
                plans[editingPlan].activities = activities;
                editingPlan = null;
            } else {
                // Adding new plan
                plans.push({ id: Date.now(), name: name, activities: activities });
            }
            
            saveData();
            renderPlansList();
            updatePlanDropdown();
            closeModal('addPlanModal');
        }
        
        function renderStudentListSimple() {
            var list = document.getElementById('studentListSimple');
            list.innerHTML = '';
            
            // Add header with student count
            if (students.length > 0) {
                var header = document.createElement('h3');
                header.style.cssText = 'margin: 20px 0 15px 0; padding-bottom: 10px; border-bottom: 2px solid #667eea; color: #2d3748; font-size: 18px;';
                header.textContent = '📚 Ученици (' + students.length + ')';
                list.appendChild(header);
            }
            
            for (var i = 0; i < students.length; i++) {
                var s = students[i];
                var plan = getPlanById(s.planId);
                var completed = (studentProgress[s.id] && studentProgress[s.id][s.planId]) ? studentProgress[s.id][s.planId].length : 0;
                var total = plan ? plan.activities.length : 0;
                
                // Count weekly sessions - two consecutive slots = one 40-min session
                var sessions40min = 0;
                var sessions20min = 0;
                
                for (var day in schedule) {
                    var processedSlots = [];
                    for (var t = 0; t < schedule[day].length; t++) {
                        if (processedSlots.indexOf(t) !== -1) continue; // Already counted
                        
                        if (schedule[day][t].indexOf(s.id) !== -1) {
                            // Check if student is also in the next consecutive slot
                            var isInNextSlot = (t + 1 < schedule[day].length && 
                                schedule[day][t + 1].indexOf(s.id) !== -1);
                            
                            // Check if previous slot was already processed (we're the second half)
                            var isPreviousProcessed = processedSlots.indexOf(t - 1) !== -1;
                            
                            if (isInNextSlot && !isPreviousProcessed) {
                                // Two consecutive slots = 1 session of 40 min (2x20 or 1x40)
                                sessions40min++;
                                processedSlots.push(t, t + 1); // Mark both as processed
                            } else if (!isPreviousProcessed) {
                                // Single slot
                                var numStudentsInSlot = schedule[day][t].length;
                                if (numStudentsInSlot === 1) {
                                    // Alone = 40 min
                                    sessions40min++;
                                } else {
                                    // With others = 20 min
                                    sessions20min++;
                                }
                                processedSlots.push(t);
                            }
                            // If isPreviousProcessed is true, do nothing (already counted)
                        }
                    }
                }

                // Calculate total sessions for display
                var totalSessions = sessions40min + sessions20min;
                var sessionDisplay = totalSessions > 0 ? totalSessions + ' сесии неделно' : 'Нема сесии';
                
                var item = document.createElement('div');
                item.className = 'student-item';
                item.innerHTML = '<div class="student-item-info">' +
                    '<h4><span style="color: #667eea; font-weight: bold; margin-right: 8px;">' + (i + 1) + '.</span>' + 
                    s.grade + ' - ' + s.name + '</h4>' +
                    '<p>План: ' + (plan ? plan.name : 'N/A') + ' | ' + sessionDisplay + '</p>' +
                    '</div>' +
                    '<div class="student-item-actions">' +
                    '<button class="btn btn-primary" style="padding: 8px 15px;" onclick="editStudent(' + i + ')">Измени</button>' +
                    '<button class="btn btn-danger" style="padding: 8px 15px;" onclick="deleteStudent(' + i + ')">Избриши</button>' +
                    '</div>';
                list.appendChild(item);
            }
        }
        
        function editStudent(idx) {
            editingStudent = idx;
            var s = students[idx];
            updatePlanDropdown();
            document.getElementById('studentName').value = s.name;
            document.getElementById('studentGrade').value = s.grade;
            document.getElementById('studentPlan').value = s.planId;
            document.getElementById('addStudentModal').classList.add('active');
        }
        
        function deleteStudent(idx) {
            if (!confirm('Избриши го ученикот?')) return;
            
            var studentId = students[idx].id;
            students.splice(idx, 1);
            
            // Remove from schedule
            for (var day in schedule) {
                for (var i = 0; i < schedule[day].length; i++) {
                    schedule[day][i] = schedule[day][i].filter(function(sid) { return sid !== studentId; });
                }
            }
            
            // Remove progress
            delete studentProgress[studentId];
            
            saveData();
            renderStudentListSimple();
            updateStats();
            updateProgressStudentList();
        }
        
        function updateStats() {
            var totalSlotsUsed = 0; // Count occupied hours (each hour = 2 slots)
            
            // Count occupied hours: if ANY student is in that hour, it's occupied = 2 slots
            for (var day in schedule) {
                for (var i = 0; i < schedule[day].length; i++) {
                    if (schedule[day][i].length > 0) {
                        // This hour is occupied (regardless of number of students)
                        totalSlotsUsed += 2;
                    }
                }
            }
            
            // Calculate capacity in 20-min slots: 5 days × 5 hours × 2 halves = 50 slots
            var maxSlots = 50;
            var totalMinutesUsed = totalSlotsUsed * 20;
            var maxCapacity = maxSlots * 20; // 1000 minutes
            var percentUsed = maxCapacity > 0 ? (totalMinutesUsed / maxCapacity * 100).toFixed(1) : 0;
            var availableMinutes = maxCapacity - totalMinutesUsed;
            
            // Update capacity display
            document.getElementById('capacityUsage').textContent = 
                totalMinutesUsed + '/' + maxCapacity + ' мин | ' + percentUsed + '% искористено';
            
            // Update progress bar
            var progressBar = document.getElementById('capacityProgressBar');
            progressBar.style.width = percentUsed + '%';
            progressBar.textContent = percentUsed + '%';
            
            // Set color based on usage
            progressBar.className = 'progress-bar-fill';
            if (percentUsed >= 100) {
                progressBar.classList.add('red');
            } else if (percentUsed >= 80) {
                progressBar.classList.add('yellow');
            } else {
                progressBar.classList.add('green');
            }
            
            // Update alert message and find free slots
            var alertDiv = document.getElementById('capacityAlert');
            alertDiv.innerHTML = '';
            
            // Find free time slots
            var freeSlots = [];
            for (var day in schedule) {
                for (var i = 0; i < schedule[day].length; i++) {
                    if (schedule[day][i].length === 0) {
                        var dayName = days[daysEng.indexOf(day)];
                        var timeLabel = timeSlots[i].label + ' (' + timeSlots[i].time + ')';
                        freeSlots.push(dayName + ' - Час ' + timeLabel);
                    }
                }
            }
            
            if (percentUsed >= 100) {
                var item = document.createElement('div');
                item.className = 'capacity-item';
                item.style.color = '#e53e3e';
                item.innerHTML = '<span class="icon">⚠️</span><span><strong>Нема слободни термини!</strong></span>';
                alertDiv.appendChild(item);
            } else if (percentUsed >= 80) {
                var available40 = Math.floor(availableMinutes / 40);
                var available20 = Math.floor(availableMinutes / 20);
                var item = document.createElement('div');
                item.className = 'capacity-item';
                item.style.color = '#d69e2e';
                item.innerHTML = '<span class="icon">🧡</span><span>' + availableMinutes + ' мин слободни (' + 
                    available20 + ' слота)</span>';
                alertDiv.appendChild(item);
                
                // Show free slots
                if (freeSlots.length > 0) {
                    var freeItem = document.createElement('div');
                    freeItem.style.cssText = 'margin-top: 10px; padding: 10px; background: rgba(237, 137, 54, 0.1); border-radius: 5px; font-size: 13px;';
                    freeItem.innerHTML = '<strong>📅 Слободни термини:</strong><br>' + freeSlots.join('<br>');
                    alertDiv.appendChild(freeItem);
                }
            } else {
                var available40 = Math.floor(availableMinutes / 40);
                var available20 = Math.floor(availableMinutes / 20);
                var item = document.createElement('div');
                item.className = 'capacity-item';
                item.style.color = '#38a169';
                item.innerHTML = '<span class="icon">💚</span><span>' + availableMinutes + ' мин слободни (' + 
                    available20 + ' слота)</span>';
                alertDiv.appendChild(item);
                
                // Show free slots
                if (freeSlots.length > 0) {
                    var freeItem = document.createElement('div');
                    freeItem.style.cssText = 'margin-top: 10px; padding: 10px; background: rgba(72, 187, 120, 0.1); border-radius: 5px; font-size: 13px;';
                    freeItem.innerHTML = '<strong>📅 Слободни термини:</strong><br>' + freeSlots.join('<br>');
                    alertDiv.appendChild(freeItem);
                }
            }
            
            // Generate session summary for all students
            var sessionStats = {}; // Format: "2x40" -> {count: N, students: [names]}
            
            for (var i = 0; i < students.length; i++) {
                var s = students[i];
                var sessions40 = 0;
                var sessions20 = 0;
                
                // Count sessions for this student (same logic as renderStudentListSimple)
                for (var day in schedule) {
                    var processedSlots = [];
                    for (var t = 0; t < schedule[day].length; t++) {
                        if (processedSlots.indexOf(t) !== -1) continue;
                        
                        if (schedule[day][t].indexOf(s.id) !== -1) {
                            var isInNextSlot = (t + 1 < schedule[day].length && 
                                schedule[day][t + 1].indexOf(s.id) !== -1);
                            var isPreviousProcessed = processedSlots.indexOf(t - 1) !== -1;
                            
                            if (isInNextSlot && !isPreviousProcessed) {
                                sessions40++;
                                processedSlots.push(t, t + 1);
                            } else if (!isPreviousProcessed) {
                                var numStudentsInSlot = schedule[day][t].length;
                                if (numStudentsInSlot === 1) {
                                    sessions40++;
                                } else {
                                    sessions20++;
                                }
                                processedSlots.push(t);
                            }
                        }
                    }
                }
                
                // Create key like "2x40+1x20" or "2x40" or "1x20"
                var key = '';
                if (sessions40 > 0) key += sessions40 + 'x40';
                if (sessions20 > 0) {
                    if (key.length > 0) key += '+';
                    key += sessions20 + 'x20';
                }
                if (key.length === 0) key = '0';
                
                if (!sessionStats[key]) {
                    sessionStats[key] = {count: 0, students: []};
                }
                sessionStats[key].count++;
                sessionStats[key].students.push(s.name);
            }
            
            // Display session summary
            var summaryDiv = document.getElementById('sessionSummary');
            summaryDiv.innerHTML = '<strong style="font-size: 14px; display: block; margin-bottom: 10px;">📊 Распределба на сесии:</strong>';
            
            var sortedKeys = Object.keys(sessionStats).sort();
            for (var i = 0; i < sortedKeys.length; i++) {
                var key = sortedKeys[i];
                var data = sessionStats[key];
                var count = data.count;
                var studentNames = data.students;
                
                if (key === '0') {
                    summaryDiv.innerHTML += '<div class="capacity-item" style="margin: 5px 0; font-size: 13px;">' +
                        '<span style="color: #718096;">• ' + count + ' ученици без распоред: ' + studentNames.join(', ') + '</span></div>';
                } else {
                    // Format key nicely: "2x40+1x20" -> "2 сесии по 40 мин + 1 сесија по 20 мин"
                    var formatted = key.replace(/(\d+)x40/g, function(match, num) {
                        return num + (num == 1 ? ' сесија' : ' сесии') + ' по 40 мин';
                    }).replace(/(\d+)x20/g, function(match, num) {
                        return num + (num == 1 ? ' сесија' : ' сесии') + ' по 20 мин';
                    }).replace('+', ' + ');
                    
                    var studentWord = count == 1 ? 'ученик' : 'ученици';
                    summaryDiv.innerHTML += '<div class="capacity-item" style="margin: 5px 0; font-size: 13px;">' +
                        '<span style="color: #2d3748;"><strong>• ' + count + ' ' + studentWord + ' со ' + formatted + ':</strong><br>' +
                        '<span style="font-size: 12px; color: #4a5568; margin-left: 12px;">' + studentNames.join(', ') + '</span></span></div>';
                }
            }
        }
        
        function updateProgressStudentList() {
            var select = document.getElementById('progressStudentSelect');
            select.innerHTML = '<option value="">-- Избери ученик --</option>';
            
            for (var i = 0; i < students.length; i++) {
                var opt = document.createElement('option');
                opt.value = students[i].id;
                opt.textContent = students[i].grade + ' - ' + students[i].name;
                select.appendChild(opt);
            }
        }
        
        function loadStudentProgress() {
            var studentId = parseInt(document.getElementById('progressStudentSelect').value);
            var container = document.getElementById('progressActivitiesList');
            container.innerHTML = '';
            
            if (!studentId) return;
            
            var student = getStudentById(studentId);
            if (!student) return;
            
            var plan = getPlanById(student.planId);
            if (!plan) {
                container.innerHTML = '<p>Ученикот нема доделен план</p>';
                return;
            }
            
            var completed = (studentProgress[studentId] && studentProgress[studentId][student.planId]) ? studentProgress[studentId][student.planId] : [];

            completed.sort(function(a, b) {
                var dateA = new Date(a.date + 'T' + a.time.split('-')[0] + ':00');
                var dateB = new Date(b.date + 'T' + b.time.split('-')[0] + ':00');
                return dateA - dateB;
            });
            
            var completedIndices = new Set(completed.map(function(c) { return c.index; }));

            // Render completed items first, in chronological order
            completed.forEach(function(activityData) {
                var i = activityData.index;
                var item = document.createElement('div');
                item.className = 'progress-item completed';
                
                var dateParts = activityData.date.split('-');
                var formattedDate = dateParts[2] + '.' + dateParts[1] + '.' + dateParts[0];
                var timestampText = 'Завршено на: ' + formattedDate + ' ' + activityData.time;

                item.innerHTML = '<input type="checkbox" checked disabled>' +
                    '<div class="progress-item-content">' +
                    '<div class="progress-item-text">' + (i + 1) + '. ' + plan.activities[i] + '</div>' +
                    '<div class="progress-item-date">' + timestampText + '</div>' +
                    '</div>';
                container.appendChild(item);
            });

            // Render uncompleted items
            for (var i = 0; i < plan.activities.length; i++) {
                if (!completedIndices.has(i)) {
                    var item = document.createElement('div');
                    item.className = 'progress-item';
                    var timestampText = 'Не е завршено';

                    item.innerHTML = '<input type="checkbox" disabled>' +
                        '<div class="progress-item-content">' +
                        '<div class="progress-item-text">' + (i + 1) + '. ' + plan.activities[i] + '</div>' +
                        '<div class="progress-item-date">' + timestampText + '</div>' +
                        '</div>';
                    container.appendChild(item);
                }
            }
        }
        
        function getActivityDate(studentId, activityIndex) {
            var student = getStudentById(studentId);
            if (!student) return 'N/A';
            
            var completed = (studentProgress[studentId] && studentProgress[studentId][student.planId]) ? studentProgress[studentId][student.planId] : [];
            
            for (var i = 0; i < completed.length; i++) {
                if (completed[i].index === activityIndex) {
                    if (completed[i].date && completed[i].time) {
                        var dateParts = completed[i].date.split('-');
                        return dateParts[2] + '.' + dateParts[1] + '.' + dateParts[0] + ' ' + completed[i].time;
                    }
                    return 'Завршено';
                }
            }
            
            return 'N/A';
        }
        
        function switchProgressView(view) {
            if (view === 'student') {
                document.getElementById('studentProgressView').style.display = 'block';
                document.getElementById('monthlyProgressView').style.display = 'none';
            } else {
                document.getElementById('studentProgressView').style.display = 'none';
                document.getElementById('monthlyProgressView').style.display = 'block';
                setCurrentMonth();
            }
        }
        
        function setCurrentMonth() {
            var now = new Date();
            document.getElementById('monthSelector').value = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
            generateMonthlyAttendance();
        }
        
        function generateMonthlyAttendance() {
            var monthValue = document.getElementById('monthSelector').value;
            if (!monthValue) return;
            
            var parts = monthValue.split('-');
            var year = parseInt(parts[0]);
            var month = parseInt(parts[1]);
            
            var container = document.getElementById('monthlyAttendanceTable');
            var html = '<table class="attendance-table">';
            html += '<tr><th>Ученик</th><th>План</th>';
            
            // Get all dates in month
            var lastDay = new Date(year, month, 0).getDate();
            for (var day = 1; day <= lastDay; day++) {
                html += '<th>' + day + '</th>';
            }
            html += '</tr>';
            
            // For each student
            for (var i = 0; i < students.length; i++) {
                var s = students[i];
                var plan = getPlanById(s.planId);
                html += '<tr><td>' + s.grade + ' - ' + s.name + '</td><td>' + (plan ? plan.name : 'N/A') + '</td>';
                
                for (var day = 1; day <= lastDay; day++) {
                    var dateStr = year + '-' + String(month).padStart(2, '0') + '-' + String(day).padStart(2, '0');
                    var hasAttendance = checkAttendanceForDate(s.id, dateStr);
                    html += '<td class="' + (hasAttendance ? 'date-cell' : '') + '">' + (hasAttendance ? '✓' : '') + '</td>';
                }
                html += '</tr>';
            }
            
            html += '</table>';
            container.innerHTML = html;
        }
        
        function checkAttendanceForDate(studentId, dateStr) {
            if (!attendance[dateStr]) return false;
            if (!attendance[dateStr][studentId]) return false;
            
            for (var key in attendance[dateStr][studentId]) {
                if (attendance[dateStr][studentId][key].status === 'present') return true;
            }
            return false;
        }
        
        function renderPlansList() {
            var container = document.getElementById('plansList');
            container.innerHTML = '';
            
            for (var i = 0; i < plans.length; i++) {
                var p = plans[i];
                var div = document.createElement('div');
                div.style.cssText = 'background: #f7fafc; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #667eea;';
                div.innerHTML = '<h4 style="margin-bottom: 10px;">' + p.name + ' (' + p.activities.length + ' активности)</h4>' +
                    '<div style="display: flex; gap: 10px;">' +
                    '<button class="btn btn-primary" onclick="editPlan(' + i + ')">Измени</button>' +
                    '<button class="btn btn-danger" onclick="deletePlan(' + i + ')">Избриши</button>' +
                    '</div>';
                container.appendChild(div);
            }
        }
        
        function deletePlan(idx) {
            if (!confirm('Избриши го планот?')) return;
            plans.splice(idx, 1);
            saveData();
            renderPlansList();
        }
        
        function getStudentById(id) {
            for (var i = 0; i < students.length; i++) {
                if (students[i].id === id) return students[i];
            }
            return null;
        }
        
        function getPlanById(id) {
            for (var i = 0; i < plans.length; i++) {
                if (plans[i].id === id) return plans[i];
            }
            return null;
        }
        
        function changeWeek(dir) {
            currentWeek += dir;
            renderSchedule();
            updateWeekDisplay();
        }
        
        function getWeekKey() {
            var now = new Date();
            now.setDate(now.getDate() + (currentWeek * 7));
            var monday = new Date(now);
            monday.setDate(now.getDate() - now.getDay() + 1);
            return monday.toISOString().split('T')[0];
        }
        
        function updateWeekDisplay() {
            var now = new Date();
            now.setDate(now.getDate() + (currentWeek * 7));
            var monday = new Date(now);
            monday.setDate(now.getDate() - now.getDay() + 1);
            var friday = new Date(monday);
            friday.setDate(monday.getDate() + 4);
            
            document.getElementById('weekDisplay').textContent = 
                monday.getDate() + '.' + (monday.getMonth()+1) + '.' + monday.getFullYear() + ' - ' + 
                friday.getDate() + '.' + (friday.getMonth()+1) + '.' + friday.getFullYear();
        }
        
        function renderSchedule() {
            var grid = document.getElementById('scheduleGrid');
            grid.innerHTML = '';
            grid.className = 'schedule-grid';
            
            // Calculate the actual week dates
            var now = new Date();
            now.setDate(now.getDate() + (currentWeek * 7));
            var monday = new Date(now);
            monday.setDate(now.getDate() - now.getDay() + 1);
            
            var headerTime = document.createElement('div');
            headerTime.className = 'schedule-header';
            headerTime.textContent = 'Час';
            grid.appendChild(headerTime);
            
            for (var i = 0; i < days.length; i++) {
                var headerDay = document.createElement('div');
                headerDay.className = 'schedule-header';
                headerDay.textContent = days[i];
                grid.appendChild(headerDay);
            }
            
            for (var t = 0; t < timeSlots.length; t++) {
                var time = timeSlots[t];
                var timeCell = document.createElement('div');
                timeCell.className = 'schedule-time';
                timeCell.innerHTML = time.label + '<br>' + time.time;
                grid.appendChild(timeCell);
                
                for (var d = 0; d < daysEng.length; d++) {
                    var day = daysEng[d];
                    var cell = document.createElement('div');
                    cell.className = 'schedule-cell';
                    if (t % 2 === 0) { cell.classList.add('odd-row'); }
                    cell.dataset.day = day;
                    cell.dataset.time = t;
                    
                    // Calculate actual date for this cell
                    var cellDate = new Date(monday);
                    cellDate.setDate(monday.getDate() + d);
                    var dateStr = cellDate.toISOString().split('T')[0];
                    
                    var studentIds = schedule[day][t];
                    for (var s = 0; s < studentIds.length; s++) {
                        var sid = studentIds[s];
                        var student = getStudentById(sid);
                        
                        if (student) {
                            var slot = document.createElement('div');
                            slot.className = 'student-slot';
                            slot.dataset.sid = sid;
                            slot.dataset.day = day;
                            slot.dataset.time = t;
                            slot.dataset.position = s;
                            
                            // Check if this is a linked session (student alone in consecutive slots)
                            var isLinkedFirst = false;
                            var isLinkedSecond = false;
                            
                            if (studentIds.length === 1) { // Student is alone in current slot
                                // Check if next slot also has only this student (linked first)
                                if (t + 1 < timeSlots.length && 
                                    schedule[day][t + 1].length === 1 && 
                                    schedule[day][t + 1][0] === sid) {
                                    isLinkedFirst = true;
                                }
                                // Check if previous slot had only this student (linked second)
                                if (t - 1 >= 0 && 
                                    schedule[day][t - 1].length === 1 && 
                                    schedule[day][t - 1][0] === sid) {
                                    isLinkedSecond = true;
                                }
                            }
                            
                            if (isLinkedFirst) slot.classList.add('linked-first');
                            if (isLinkedSecond) slot.classList.add('linked-second');
                            
                            var key = day + '-' + t;
                            var status = null;
                            
                            if (attendance[dateStr] && attendance[dateStr][sid] && attendance[dateStr][sid][key]) {
                                status = attendance[dateStr][sid][key].status;
                            }
                            
                            if (status === 'present') slot.classList.add('present');
                            if (status === 'absent') slot.classList.add('absent');
                            
                            // Build slot content with order indicator (no reorder buttons)
                            var orderLabel = '';
                            if (studentIds.length > 1) {
                                orderLabel = '<span class="student-slot-order">' + (s + 1) + '/' + studentIds.length + '</span>';
                            }
                            
                            slot.innerHTML = orderLabel + '<span class="student-slot-name">' + student.grade + ' - ' + student.name + '</span>';
                            cell.appendChild(slot);
                        }
                    }
                    
                    grid.appendChild(cell);
                }
            }
            
            setTimeout(function() {
                var slots = document.querySelectorAll('.student-slot');
                for (var i = 0; i < slots.length; i++) {
                    slots[i].addEventListener('click', function(e) {
                        e.stopPropagation();
                        var sid = parseInt(this.dataset.sid);
                        var day = this.dataset.day;
                        var timeIdx = parseInt(this.dataset.time);
                        toggleAttendance(sid, day, timeIdx);
                    });
                }
                
                var cells = document.querySelectorAll('.schedule-cell');
                for (var i = 0; i < cells.length; i++) {
                    cells[i].addEventListener('click', function(e) {
                        if (e.target === this) {
                            var day = this.dataset.day;
                            var timeIdx = parseInt(this.dataset.time);
                            openAssignModal(day, timeIdx);
                        }
                    });
                }
            }, 0);
        }
        
        function openAssignModal(day, timeIdx) {
            currentSlot = { day: day, timeIdx: timeIdx };
            var list = document.getElementById('checkboxList');
            list.innerHTML = '';
            
            var current = schedule[day][timeIdx];
            checkOrder = current.slice(); // Copy current order
            
            for (var i = 0; i < students.length; i++) {
                var s = students[i];
                var item = document.createElement('div');
                item.className = 'checkbox-item';
                var checked = current.indexOf(s.id) !== -1 ? 'checked' : '';
                item.innerHTML = '<input type="checkbox" id="cb-' + s.id + '" value="' + s.id + '" ' + checked + '>' +
                    '<label for="cb-' + s.id + '">' + s.grade + ' - ' + s.name + '</label>';
                list.appendChild(item);
            }
            
            // Add event listeners to track check order
            setTimeout(function() {
                var checkboxes = document.querySelectorAll('#checkboxList input[type="checkbox"]');
                for (var i = 0; i < checkboxes.length; i++) {
                    checkboxes[i].addEventListener('change', function() {
                        var id = parseInt(this.value);
                        if (this.checked) {
                            // Add to order if not already there
                            if (checkOrder.indexOf(id) === -1) {
                                checkOrder.push(id);
                            }
                        } else {
                            // Remove from order
                            var idx = checkOrder.indexOf(id);
                            if (idx !== -1) {
                                checkOrder.splice(idx, 1);
                            }
                        }
                    });
                }
            }, 0);
            
            document.getElementById('assignModal').classList.add('active');
        }
        
        function assignStudents() {
            if (!currentSlot) return;
            
            // Use checkOrder instead of DOM order
            schedule[currentSlot.day][currentSlot.timeIdx] = checkOrder.slice();
            
            saveData();
            renderSchedule();
            renderStudentListSimple();
            updateStats();
            closeModal('assignModal');
        }
        
        function toggleAttendance(sid, day, timeIdx) {
            // Calculate the actual date for this day in the current week
            var now = new Date();
            now.setDate(now.getDate() + (currentWeek * 7));
            var monday = new Date(now);
            monday.setDate(now.getDate() - now.getDay() + 1);
            
            var dayIndex = daysEng.indexOf(day);
            var actualDate = new Date(monday);
            actualDate.setDate(monday.getDate() + dayIndex);
            var dateStr = actualDate.toISOString().split('T')[0];
            
            if (!attendance[dateStr]) attendance[dateStr] = {};
            if (!attendance[dateStr][sid]) attendance[dateStr][sid] = {};
            
            var key = day + '-' + timeIdx;
            var current = attendance[dateStr][sid][key];
            var timeSlot = timeSlots[timeIdx].time;

            if (!current) {
                // Unaddressed -> Present
                attendance[dateStr][sid][key] = { status: 'present', date: dateStr, time: timeSlot };
                checkNextActivity(sid, dateStr, timeSlot);
            } else if (current.status === 'present') {
                // Present -> Absent
                attendance[dateStr][sid][key] = { status: 'absent', date: dateStr, time: timeSlot };
                uncheckLastActivity(sid, dateStr, timeSlot);
            } else if (current.status === 'absent') {
                // Absent -> Unaddressed (reset)
                delete attendance[dateStr][sid][key];
            }
            
            saveData();
            renderSchedule();
        }
        
        function uncheckLastActivity(studentId, dateStr, timeSlot) {
            var student = getStudentById(studentId);
            if (!student) return;

            var completed = (studentProgress[studentId] && studentProgress[studentId][student.planId]) ? studentProgress[studentId][student.planId] : [];
            if (completed.length === 0) return;

            // Find the specific activity completed on this date and time to remove it
            let activityToRemoveIndex = -1;
            for (let i = completed.length - 1; i >= 0; i--) {
                if (completed[i].date === dateStr && completed[i].time === timeSlot) {
                    activityToRemoveIndex = i;
                    break;
                }
            }

            if (activityToRemoveIndex > -1) {
                completed.splice(activityToRemoveIndex, 1);
            }
        }

        function checkNextActivity(studentId, dateStr, timeSlot) {
            var student = getStudentById(studentId);
            if (!student) return;
            
            var plan = getPlanById(student.planId);
            if (!plan || !plan.activities || plan.activities.length === 0) return;
            
            if (!studentProgress[studentId]) {
                studentProgress[studentId] = {};
            }
            if (!studentProgress[studentId][student.planId]) {
                studentProgress[studentId][student.planId] = [];
            }
            
            var completed = studentProgress[studentId][student.planId];
            
            for (var i = 0; i < plan.activities.length; i++) {
                var alreadyCompleted = false;
                for (var j = 0; j < completed.length; j++) {
                    if (completed[j].index === i) {
                        alreadyCompleted = true;
                        break;
                    }
                }
                
                if (!alreadyCompleted) {
                    completed.push({
                        index: i,
                        date: dateStr,
                        time: timeSlot
                    });
                    break;
                }
            }
            
            saveData();
        }
        
        function saveData() {
            var data = { students: students, schedule: schedule, attendance: attendance, plans: plans, studentProgress: studentProgress };
            localStorage.setItem('electronicDiary', JSON.stringify(data));
            isDataDirty = true;
        }
        
        function loadData() {
            var saved = localStorage.getItem('electronicDiary');
            if (saved) {
                var data = JSON.parse(saved);
                if (data.students) students = data.students;
                if (data.schedule) schedule = data.schedule;
                if (data.attendance) attendance = data.attendance;
                if (data.plans) plans = data.plans;
                if (data.studentProgress) studentProgress = data.studentProgress;
            }
            isDataDirty = false;
        }
        
        function exportData() {
            var data = { students: students, schedule: schedule, attendance: attendance, plans: plans, studentProgress: studentProgress };
            var blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'diary_export_' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
            isDataDirty = false; // Data is now considered 'saved'
            alert('Експортирано!');
        }
        
        function importData(e) {
            var file = e.target.files[0];
            if (!file) return;
            
            var reader = new FileReader();
            reader.onload = function(event) {
                try {
                    var data = JSON.parse(event.target.result);
                    if (data.students) students = data.students;
                    if (data.schedule) schedule = data.schedule;
                    if (data.attendance) attendance = data.attendance;
                    if (data.plans) plans = data.plans;
                    if (data.studentProgress) studentProgress = data.studentProgress;
                    saveData();
                    renderAll();
                    alert('Импортирано успешно!');
                } catch (err) {
                    alert('Грешка при вчитување: ' + err.message);
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        }
        
        function renderAll() {
            renderStudentListSimple();
            renderSchedule();
            updateWeekDisplay();
            renderPlansList();
            updateStats();
            updateProgressStudentList();
        }
        
        function manualSave() {
            saveData();
            alert('Зачувано!');
        }
        
        // Initialize
        loadData();
        renderAll();

        // Dark Mode Logic
        const toggleSwitch = document.querySelector('.theme-switch input[type="checkbox"]');
        const currentTheme = localStorage.getItem('theme');

        if (currentTheme) {
            document.body.classList.add(currentTheme);
        
            if (currentTheme === 'dark-mode') {
                toggleSwitch.checked = true;
            }
        }

        function switchTheme(e) {
            if (e.target.checked) {
                document.body.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
                localStorage.setItem('theme', 'light-mode');
            }
        }

        toggleSwitch.addEventListener('change', switchTheme, false);

        // Warn user about unsaved changes
        window.addEventListener('beforeunload', function (e) {
            if (isDataDirty) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>